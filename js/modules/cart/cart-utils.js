const API_URL = "https://backendalcraft-production.up.railway.app";

export function getCurrentUser() {
  const userId = localStorage.getItem("userId");
  const token = localStorage.getItem("access_token");
  
  console.log('üîç DEBUG getCurrentUser:', { 
    userId, 
    token,
    storedUserId: localStorage.getItem("userId"),
    storedToken: localStorage.getItem("access_token")
  });

  return {
    userId: userId,
    token: token,

  };
}
let currentProduct = null; 
export function showSizeModal(sizes) {
  const modal = document.getElementById('size-modal');
  const sizeGrid = modal.querySelector('.size-grid');
  const confirmBtn = modal.querySelector('.wb-modal__confirm');

  sizeGrid.innerHTML = '';

  sizes.forEach(size => {
    const sizeItem = document.createElement('div');
    sizeItem.className = 'size-item';
    sizeItem.innerHTML = `
      <input type="radio" name="size" value="${size}" id="size-${size}" class="size-input">
      <label for="size-${size}" class="size-label">${size}</label>
    `;
    sizeGrid.appendChild(sizeItem);
  });

  confirmBtn.disabled = true;

  const sizeInputs = modal.querySelectorAll('.size-input');
  sizeInputs.forEach(input => {
    input.addEventListener('change', () => {
      confirmBtn.disabled = false;
    });
  });

  modal.style.display = 'flex';
  document.body.style.overflow = 'hidden'; 

  return new Promise((resolve, reject) => {
    const onConfirm = () => {
      const selectedSize = modal.querySelector('.size-input:checked').value;
      hideModal();
      resolve(selectedSize);
    };
    
    const onClose = () => {
      hideModal();
      reject(new Error('–í—ã–±–æ—Ä —Ä–∞–∑–º–µ—Ä–∞ –æ—Ç–º–µ–Ω–µ–Ω'));
    };
    
    const hideModal = () => {
      modal.style.display = 'none';
      document.body.style.overflow = ''; // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∫—Ä–æ–ª–ª
    };
    
    // –í–µ—à–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
    confirmBtn.addEventListener('click', onConfirm);
    modal.querySelector('.wb-modal__close').addEventListener('click', onClose);
    modal.querySelector('.wb-modal__overlay').addEventListener('click', onClose);
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ Escape
    const onEscape = (e) => {
      if (e.key === 'Escape') onClose();
    };
    document.addEventListener('keydown', onEscape);
    
    // –£–±–∏—Ä–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–æ—Å–ª–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
    const cleanup = () => {
      confirmBtn.removeEventListener('click', onConfirm);
      modal.querySelector('.wb-modal__close').removeEventListener('click', onClose);
      modal.querySelector('.wb-modal__overlay').removeEventListener('click', onClose);
      document.removeEventListener('keydown', onEscape);
    };
  });
}

// –§—É–Ω–∫—Ü–∏—è —Å–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
function hideSizeModal() {
    const modal = document.getElementById('size-modal');
    if (modal) {
        modal.style.display = 'none';
    }
    currentProduct = null;
}
export const getCart = () => {
  const { userId } = getCurrentUser(); // üî• –î–û–ë–ê–í–ò–õ–ò isAuthenticated
  
  console.log('üõí getCart called for user:', userId);

  const cartData = localStorage.getItem(`cart_${userId}`);
  
  try {
    const cart = JSON.parse(cartData);
    return Array.isArray(cart) ? cart : [];
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –∫–æ—Ä–∑–∏–Ω—ã:', error);
    return [];
  }
};

export const setCart = (cart) => {
  const { userId } = getCurrentUser();
  console.log(`–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ—Ä–∑–∏–Ω—ã –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${userId}:`, cart);
  localStorage.setItem(`cart_${userId}`, JSON.stringify(cart));
};

export function formatRub(n) {
  return new Intl.NumberFormat("ru-RU").format(Number(n) || 0) + " ‚ÇΩ";
}

export function updateCounter() {
  const cart = getCart();
  const total = cart.reduce((s, i) => s + (Number(i.quantity) || 1), 0);

  ["count", "counter", "quant", "cart-count"].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.textContent = total;
  });

  const totalPrice = cart.reduce((s, i) => s + (Number(i.price) * Number(i.quantity) || 0), 0);
  const totalEl = document.getElementById('cart-total');
  if (totalEl) totalEl.textContent = formatRub(totalPrice);
}

export function uid() {
  if (window.crypto?.randomUUID) return crypto.randomUUID();
  return "id-" + Date.now().toString(36) + Math.random().toString(36).slice(2, 8);
}

function firstPic(p) {
  if (!p) return "";
  if (Array.isArray(p)) return p[0] || "";
  return p;
}

function buildKey(p) {
  return [
    (p.tShirtName || "").trim().toLowerCase(),
    (p.size || "").toString().trim().toLowerCase(),
    (p.color || "").toString().trim().toLowerCase(),
    (p.cut || "").toString().trim().toLowerCase(),
    (p.nameCollection || "").toString().trim().toLowerCase(),
    firstPic(p.picturePath)
  ].join("||");
}

export async function addToCart(product) {
    if ((product.sizes && product.sizes.length > 0) && !product.selectedSize) {
        showSizeModal(product);
        return;
    }

    product.quantity = Math.max(1, Number(product.quantity) || 1);
    product.price = Number(product.price) || 0;

    if (!product.productId) {
        product.productId = product._id || uid();
    }

    let cart = getCart();
    const keyNew = buildKey(product);
    const existingIndex = cart.findIndex(item => buildKey(item) === keyNew);

    if (existingIndex !== -1) {
        cart[existingIndex].quantity = (Number(cart[existingIndex].quantity) || 1) + product.quantity;
    } else {
        if (!product._id) product._id = uid();
        cart.push(product);
    }

    setCart(cart);
    updateCounter();
    window.dispatchEvent(new CustomEvent("cart:updated", { detail: { cart } }));

    try {
        await saveCartToServer(cart);
        console.log('–¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–æ—Ä–∑–∏–Ω—É');
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –∫–æ—Ä–∑–∏–Ω—É:', error);
    }
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ä–∞–∑–º–µ—Ä
    if (product.selectedSize) {
        delete product.selectedSize;
    }
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
document.addEventListener('DOMContentLoaded', function() {
    // –ö–Ω–æ–ø–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –≤—ã–±–æ—Ä–∞ —Ä–∞–∑–º–µ—Ä–∞
    const confirmBtn = document.getElementById('confirm-size');
    const cancelBtn = document.getElementById('cancel-size');
    const modal = document.getElementById('size-modal');
    
    if (confirmBtn) {
        confirmBtn.addEventListener('click', () => {
            if (currentProduct && currentProduct.selectedSize) {
                addToCart(currentProduct);
                hideSizeModal();
            } else {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–º–µ—Ä');
            }
        });
    }
    
    if (cancelBtn) {
        cancelBtn.addEventListener('click', hideSizeModal);
    }
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    if (modal) {
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                hideSizeModal();
            }
        });
    }
});

function findCartItem(itemId, productId = null) {
  const cart = getCart();

  if (productId) {
    const item = cart.find(i => i.productId === productId || i._id === productId);
    if (item) return item;
  }
  
  if (itemId) {
    return cart.find(i => i._id === itemId || i.productId === itemId);
  }
  
  return null;
}
export async function updateMultipleCartItems(updates) {
  let cart = getCart();
  let hasChanges = false;

  updates.forEach(update => {
    const item = findCartItem(null, update.productId);
    if (item && item.quantity !== update.quantity) {
      item.quantity = Math.max(1, Number(update.quantity) || 1);
      item.lastUpdated = Date.now();
      hasChanges = true;
    }
  });

  if (hasChanges) {
    setCart(cart);
    updateCounter();
    
    try {
      await saveCartToServer(cart);
      console.log('‚úÖ –ö–æ—Ä–∑–∏–Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
      return true;
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –∫–æ—Ä–∑–∏–Ω—ã:', error);
      // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –º–µ—Ö–∞–Ω–∏–∑–º –ø–æ–≤—Ç–æ—Ä–∞ –∏–ª–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      return false;
    }
  }
  
  return true;
}
export async function updateCartItemQuantity(productId, newQuantity) {
  let cart = getCart();
  const item = findCartItem(null, productId);
  
  if (item) {
    const oldQuantity = item.quantity;
    item.quantity = Math.max(1, Number(newQuantity) || 1);
    item.lastUpdated = Date.now();
    setCart(cart);
    updateCounter();
    
    try {
      // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Å —Å–µ—Ä–≤–µ—Ä–æ–º
      await saveCartToServer(cart);
      console.log('‚úÖ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ');
    } catch (error) {
      // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ - –æ—Ç–∫–∞—Ç—ã–≤–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
      item.quantity = oldQuantity;
      setCart(cart);
      updateCounter();
      console.error('‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:', error);
      throw error;
    }
  }
}

export async function removeFromCart(productId) {
    try {
        // 1. –ü–æ–ª—É—á–∞–µ–º userId
        const userId = localStorage.getItem('userId');
        if (!userId) {
            console.error('UserId –Ω–µ –Ω–∞–π–¥–µ–Ω');
            return false;
        }
        
        // 2. –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é –∫–æ—Ä–∑–∏–Ω—É (–ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º null)
        const cartKey = `cart_${userId}`;
        const cartData = localStorage.getItem(cartKey);
        const cart = cartData ? JSON.parse(cartData) : [];
        
        console.log('üì¶ –ö–æ—Ä–∑–∏–Ω–∞ –¥–æ —É–¥–∞–ª–µ–Ω–∏—è:', cart);
        console.log('üéØ –£–¥–∞–ª—è–µ–º productId:', productId);
        
        // 3. –§–∏–ª—å—Ç—Ä—É–µ–º –º–∞—Å—Å–∏–≤, —É–±–∏—Ä–∞—è —Ç–æ–≤–∞—Ä
        const newCart = cart.filter(item => {
            const matches = item.productId === productId || item._id === productId;
            console.log(`üîç –¢–æ–≤–∞—Ä ${item.productId || item._id}: ${matches ? '–£–î–ê–õ–Ø–ï–ú' : '–û–°–¢–ê–í–õ–Ø–ï–ú'}`);
            return !matches;
        });
        
        console.log('üì¶ –ö–æ—Ä–∑–∏–Ω–∞ –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è:', newCart);
        
        // 4. –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±—Ä–∞—Ç–Ω–æ –≤ localStorage
        localStorage.setItem(cartKey, JSON.stringify(newCart));

        // 5. –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫
        const total = newCart.reduce((sum, item) => sum + (item.quantity || 1), 0);
        const countElement = document.getElementById('count');
        if (countElement) {
            countElement.textContent = total;
        }
        
        await saveCartToServer(newCart);
        // 6. –í—ã–∑—ã–≤–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–±—â–µ–π —Å—É–º–º—ã (–µ—Å–ª–∏ —Ç–∞–∫–∞—è —Ñ—É–Ω–∫—Ü–∏—è –µ—Å—Ç—å)
        if (typeof updateCartTotal === 'function') {
            updateCartTotal();
        }
        
        console.log('‚úÖ –¢–æ–≤–∞—Ä —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω');
        return true;
        
    } catch (error) {
        console.error('üí• –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏:', error);
        return false;
    }
}
export async function fetchCartFromServer() {
  const { userId, token } = getCurrentUser();
  
  if (!token || userId === "guest") {
    console.log('–ì–æ—Å—Ç–µ–≤–∞—è –∫–æ—Ä–∑–∏–Ω–∞');
    return getCart();
  }

  try {
    const res = await fetch(`${API_URL}/cart/get/${userId}`, {
      headers: { 
        "Authorization": `Bearer ${token}`,
        "Accept": "application/json"
      }
    });
    
    if (!res.ok) {
      if (res.status === 404) {
        console.log('–ö–æ—Ä–∑–∏–Ω–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
        return getCart(); 
      }
      throw new Error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ—Ä–∑–∏–Ω—ã: ${res.status}`);
    }
    
    const data = await res.json();
    console.log('–ö–æ—Ä–∑–∏–Ω–∞ —Å —Å–µ—Ä–≤–µ—Ä–∞:', data);

    const currentCart = getCart();
    
    let serverItems = [];
    if (data.data && data.data.items && Array.isArray(data.data.items)) {
      serverItems = data.data.items;
    }

    const mergedCart = mergeCarts(currentCart, serverItems);
    
    console.log('–û–±—ä–µ–¥–∏–Ω–µ–Ω–Ω–∞—è –∫–æ—Ä–∑–∏–Ω–∞:', mergedCart);
    setCart(mergedCart);
    updateCounter();
    
    // üî• –°–ò–ù–•–†–û–ù–ò–ó–ò–†–£–ï–ú –û–ë–™–ï–î–ò–ù–ï–ù–ù–£–Æ –ö–û–†–ó–ò–ù–£ –ù–ê –°–ï–†–í–ï–†
    await saveCartToServer(mergedCart);
    
    return mergedCart;
    
  } catch (err) {
    console.error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É —Å —Å–µ—Ä–≤–µ—Ä–∞:", err);
    // üî• –ü–†–ò –û–®–ò–ë–ö–ï –í–û–ó–í–†–ê–©–ê–ï–ú –¢–ï–ö–£–©–£–Æ –ö–û–†–ó–ò–ù–£
    return getCart();
  }
}

// üî• –§–£–ù–ö–¶–ò–Ø –û–ë–™–ï–î–ò–ù–ï–ù–ò–Ø –ö–û–†–ó–ò–ù
function mergeCarts(localCart, serverItems) {
  if (!serverItems.length) return localCart;

  const serverCart = serverItems.map(serverItem => ({
    _id: serverItem.id || uid(),
    productId: serverItem.productId,
    tShirtName: serverItem.name,
    price: serverItem.price,
    quantity: serverItem.quantity,
    size: serverItem.size,
    color: serverItem.color,
    picturePath: serverItem.picturePath,
    nameCollection: serverItem.nameCollection,
    discount: serverItem.discount,
    cut: serverItem.cut,
    lastUpdated: Date.now() 
  }));

  const merged = [...localCart];
  
  serverCart.forEach(serverItem => {
    const existingIndex = merged.findIndex(item => 
      item.productId === serverItem.productId
    );
    
    if (existingIndex === -1) {

      merged.push(serverItem);
    } else {
      // üî• –°–û–•–†–ê–ù–Ø–ï–ú –õ–û–ö–ê–õ–¨–ù–û–ï –ö–û–õ–ò–ß–ï–°–¢–í–û, –ï–°–õ–ò –û–ù–û –ë–´–õ–û –ò–ó–ú–ï–ù–ï–ù–û
      const localItem = merged[existingIndex];
      if (localItem.quantity !== serverItem.quantity) {
        console.log('–°–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–ª—è —Ç–æ–≤–∞—Ä–∞:', localItem.tShirtName);
        // –õ–æ–∫–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
      }
      // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å —Å–µ—Ä–≤–µ—Ä–∞
      merged[existingIndex] = {
        ...serverItem,
        quantity: localItem.quantity, // üî• –°–û–•–†–ê–ù–Ø–ï–ú –õ–û–ö–ê–õ–¨–ù–û–ï –ö–û–õ–ò–ß–ï–°–¢–í–û
        _id: localItem._id // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π ID
      };
    }
  });
  
  return merged;
}

export async function saveCartToServer(cart = null) { // ‚úÖ –ó–ù–ê–ß–ï–ù–ò–ï –ü–û –£–ú–û–õ–ß–ê–ù–ò–Æ
  const { userId, token } = getCurrentUser();
  
  if (!token || userId === "guest") {
    console.log('–ì–æ—Å—Ç–µ–≤–∞—è –∫–æ—Ä–∑–∏–Ω–∞ - —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –ª–æ–∫–∞–ª—å–Ω–æ');
    return;
  }

  // üî• –ï–°–õ–ò cart –ù–ï –ü–ï–†–ï–î–ê–ù, –ë–ï–†–ï–ú –ò–ó localStorage
  const cartToSave = cart || getCart();
  
  try {
    const itemsToSend = cartToSave.map(item => ({
      discount: item.discount,
      productId: item.productId || item._id,
      name: item.tShirtName || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–æ–≤–∞—Ä',
      price: item.price || 0,
      quantity: item.quantity,
      size: item.size,
      color: item.color,
      picturePath: item.picturePath || '',
      nameCollection: item.nameCollection,
      cut: item.cut
    }));

    console.log('–û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä:', itemsToSend);

    const res = await fetch(`${API_URL}/cart/add`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${token}`
      },
      body: JSON.stringify({
        userId: userId,
        items: itemsToSend
      })
    });

    if (!res.ok) {
      const errorData = await res.json().catch(() => ({}));
      throw new Error(errorData.message || `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${res.status}`);
    }

    const result = await res.json();
    console.log('–ö–æ—Ä–∑–∏–Ω–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä:', result);
    return result;
    
  } catch (err) {
    console.error("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É –Ω–∞ —Å–µ—Ä–≤–µ—Ä:", err);
    throw err;
  }
}

// üî• –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –°–û–ë–´–¢–ò–ô - –†–ê–ë–û–¢–ê–Æ–¢ –° productId
export function setupCartEventListeners() {
  document.addEventListener('click', async (e) => {
    const increaseBtn = e.target.closest('.increase');
    const decreaseBtn = e.target.closest('.decrease');
    const removeBtn = e.target.closest('.remove');

    if (increaseBtn || decreaseBtn || removeBtn) {
      e.preventDefault();
      
      const card = (increaseBtn || decreaseBtn || removeBtn).closest('[data-product-id]');
      if (!card) return;

      const productId = card.dataset.productId;
      if (!productId) return;

      if (increaseBtn) {
        await updateCartItemQuantity(productId, 
          (parseInt(card.querySelector('.quantity-value').textContent) || 1) + 1
        );
      } else if (decreaseBtn) {
        await updateCartItemQuantity(productId, 
          Math.max(1, (parseInt(card.querySelector('.quantity-value').textContent) || 1) - 1)
        );
      } else if (removeBtn) {
        if (confirm('–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã?')) {
          await removeFromCart(productId);
        }
      }
    }
  });
}


export async function retryFailedSync() {
  const { userId, token } = getCurrentUser();
  
  if (!token || userId === "guest") return;

  const errorKey = `cart_error_${userId}`;
  const errorData = localStorage.getItem(errorKey);
  
  if (errorData) {
    try {
      const { cart, timestamp } = JSON.parse(errorData);
      console.log('üîÑ –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –∫–æ—Ä–∑–∏–Ω—ã...');
      
      const result = await saveCartToServer(cart);
      
      if (result.success) {
        localStorage.removeItem(errorKey);
        console.log('‚úÖ –ü–æ–≤—Ç–æ—Ä–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞');
      }
    } catch (error) {
      console.error('‚ùå –ü–æ–≤—Ç–æ—Ä–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –Ω–µ —É–¥–∞–ª–∞—Å—å:', error);
    }
  }
}
export function setupCartButtons() {
  document.addEventListener('click', async (e) => {
    const addButton = e.target.closest('.add-to-cart');
    if (!addButton) return;

    e.preventDefault();
    
    const product = {
      discount: addButton.dataset.discount,
      productId: addButton.dataset.productId, 
      price: parseFloat(addButton.dataset.price),
      size: addButton.dataset.size,
      color: addButton.dataset.color,
      picturePath: addButton.dataset.image,
      quantity: 1
    };

    try {
      await addToCart(product);
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è:', error);
    }
  });
}
export function setupBuyButtons() {
    document.addEventListener('click', async (e) => {
        const buyButton = e.target.closest('.buy');
        if (!buyButton) return;

        e.preventDefault();

        const product = {
            productId: buyButton.dataset.productId,
            tShirtName: buyButton.dataset.name,
            price: parseFloat(buyButton.dataset.price),
            sizes: buyButton.dataset.sizes ? JSON.parse(buyButton.dataset.sizes) : [], // –ú–∞—Å—Å–∏–≤ —Ä–∞–∑–º–µ—Ä–æ–≤
            color: buyButton.dataset.color,
            picturePath: buyButton.dataset.image,
            quantity: 1
        };

        showSizeModal(product);
    });
}
document.addEventListener('click', async (e) => {
    if (e.target.closest('.remove')) {
        const card = e.target.closest('.t-shirt-card');
        const productId = card.dataset.productId || card.dataset.id;

        const success = await removeFromCart(productId);
        
        if (success) {

            card.remove();
        }
        updateCartTotal();
    }
});
setInterval(retryFailedSync, 30000);